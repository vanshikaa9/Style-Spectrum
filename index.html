<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outfit Color Predictor</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Link External CSS -->
    <link rel="stylesheet" href="styles.css"> 
    
    <!-- Load Firebase Libraries (MUST BE TYPE="MODULE" and loaded first) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for the non-module script.js to access
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel
        };

        // Initialize Firebase and Auth (required for database access)
        window.initializeFirebase = async () => {
            try {
                // Mandatory Global Variables provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    document.getElementById('error-message').textContent = "Database Error: Firebase configuration not found.";
                    return;
                }

                const app = firebase.initializeApp(firebaseConfig);
                window.db = firebase.getFirestore(app);
                window.auth = firebase.getAuth(app);
                window.appId = appId;

                // Log into the environment
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await firebase.signInAnonymously(window.auth);
                }

                // Set up auth state listener
                firebase.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-info').textContent = `User ID: ${window.userId}`;
                        // Once authenticated, start loading data (function is in script.js)
                        if (typeof loadPalettes === 'function') loadPalettes();
                    } else {
                        document.getElementById('user-info').textContent = "Authenticating...";
                    }
                });

                firebase.setLogLevel('Debug');
                console.log("Firebase initialized successfully.");

            } catch (e) {
                console.error("Error during Firebase initialization:", e);
                document.getElementById('error-message').textContent = `Database Initialization Error: ${e.message}`;
            }
        };

        window.initializeFirebase();
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center items-start">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">
        <div class="flex justify-between items-start mb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight">
                Outfit Color Harmony Analyzer
            </h1>
            <span id="user-info" class="text-xs text-gray-400 p-1 bg-gray-100 rounded">Authenticating...</span>
        </div>
        <p class="text-gray-500 mb-8">Upload an image to analyze its dominant color and get suggested pairings based on color theory. Palettes can be saved to the database.</p>

        <!-- Input and Preview Area -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="flex flex-col space-y-4">
                <label for="imageUpload" class="block text-lg font-medium text-gray-700">1. Select Clothing Image</label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="handleImageUpload()">
                <button onclick="analyzeImage()" id="analyzeButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-150 disabled:opacity-50" disabled>
                    Analyze Colors
                </button>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 flex flex-col items-center justify-center border border-dashed border-gray-300 h-64">
                <h3 class="text-gray-600 mb-3 font-semibold">Image Preview</h3>
                <img id="imagePreview" class="max-h-full max-w-full rounded-lg shadow-md object-contain" alt="Image Preview" style="display: none;">
                <p id="previewText" class="text-gray-400">Your image will appear here.</p>
            </div>
        </div>

        <!-- Hidden Canvas for Processing -->
        <canvas id="color-canvas"></canvas>

        <!-- Results Area -->
        <div id="resultsArea" class="mt-10 pt-8 border-t border-gray-200" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Suggested Pairings</h2>
            
            <!-- Dominant Color Display -->
            <div class="mb-8 p-4 border border-gray-200 rounded-xl bg-indigo-50 flex flex-col sm:flex-row items-center justify-between shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 sm:mb-0">Your Dominant Color:</h3>
                <div class="flex items-center space-x-4">
                    <div id="dominantSwatch" class="w-12 h-12 rounded-full shadow-lg border-2 border-white"></div>
                    <span id="dominantRGB" class="text-lg font-mono text-gray-600"></span>
                </div>
            </div>

            <!-- Pairing Suggestions -->
            <div id="suggestionsContainer" class="space-y-6 mb-6">
                <!-- Suggestions will be injected here -->
            </div>

            <div class="flex justify-end">
                <button onclick="saveCurrentPalette()" id="saveButton" class="bg-emerald-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-emerald-600 transition duration-150 disabled:opacity-50" disabled>
                    Save Palette
                </button>
            </div>
            
            <p id="error-message" class="mt-6 text-red-600 font-medium" style="display: none;"></p>

        </div>

        <!-- Saved Palettes Area -->
        <div class="mt-10 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Saved Palettes (Firestore)</h2>
            <div id="savedPalettesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="loadingPalettes" class="text-gray-500 col-span-full">Loading saved palettes...</p>
                <!-- Saved palettes will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Link External JavaScript -->
    <script src="script.js"></script>
</body>
</html>
